# UltraDefense ‚Äì Lightweight Ultrasonic Attack Detection & Blocking

**Project by:** Vadthya Sandeep  
**Roll No:** M24EET020  
**Institute:** IIT Jodhpur ‚Äì M.Tech Sensors & IoT

---

## 1. Overview

UltraDefense implements a complete pipeline to **simulate, analyze, and defend** against ultrasonic AM-modulated microphone injection attacks (‚ÄúDolphinAttack‚Äù) targeting smart earbuds.  
**Key components include:**

- Audio resampling
- AM attack generation
- Nonlinear demodulation simulation
- Ultrasonic band-energy analysis
- Adaptive attack detector
- Audio blocking defense
- ASR (wake-word) success measurement
- Phase-1, Phase-2, Phase-3 experimental pipelines
**Scientific Summary:**
UltraDefense detects ultrasonic command injection attacks by analyzing high-frequency band energy (>18 kHz) using adaptive percentile thresholding on STFT frames. When an attack is detected, only the malicious region is muted (‚âà300‚Äì400 ms), ensuring zero false rejects, low latency (~64 ms), and no hardware modification. The method is fully DSP-only, making it suitable for resource-constrained earbud SoCs.

---

## 2. Folder Contents

| File Name             | Purpose                                         |
|-----------------------|-------------------------------------------------|
| `convert.py`          | Convert .m4a ‚Üí 96 kHz WAV                       |
| `gen_attack_strong.py`| Generate 23 kHz AM-modulated ultrasonic attack  |
| `demod_sim.py`        | Simulate microphone nonlinearity & demodulation |
| `measure_similarity.py`| Compare demodulated audio with wake-word        |
| `analyze_band.py`     | Analyze ultrasonic band energy (18‚Äì34 kHz)      |
| `detector_adaptive.py`| Adaptive energy-based attack detector           |
| `detect_and_block.py` | Defense: mute attack regions automatically      |
| `asr_check_nosmodel.py`| Proxy ASR classifier (wake-word match score)    |
| `phase2.py`           | Batch testing across noise/SNR/attenuation      |
| `phase3.py`           | Full stress testing: noise + speed change + attenuation |
| `README.md`           | This instructions file                          |

---

## 3. Required Input Files

Place the following files in the project directory **before running any script**:

- `hey_google_96k.wav` ‚Äî Wake-word sample (converted)
- `noise.wav` ‚Äî Noise sample (converted)
- `attack_am_strong_23k.wav` ‚Äî (generated by script)
- `Normal1cam.m4a`, `Normalflash.m4a`, `Normalset.m4a` ‚Äî Normal speech samples for false positive testing

---
## **üìÅ Repository Structure**
Your project ZIP includes:

- All Python `.py` modules  
- A Google Colab `.ipynb` notebook  
- WAV files (resampled, generated, blocked)  
- PNG plots (spectrograms, waveforms, detection graphs)  
- Evaluation CSV files  
- README.md  

---

## **üì• 1. Setup Instructions**
### **A. If using Python locally**
Install required packages:

numpy  
scipy  
matplotlib  
soundfile  
librosa  
pyroomacoustics  
vosk  
tqdm  
pandas  

### **B. If using Google Colab**
1. Upload the ZIP folder or individual `.py` files  
2. Upload required audio files (raw recordings, attack wav, noise wav) into the Colab left panel under **Files**  
3. Run the notebook cells in order ‚Äî the notebook already imports and calls each `.py` module where needed  

---

## **üìÇ 2. Required Input Files**
Before running any scripts, ensure these files are placed inside the **project folder** or uploaded in Colab:

- Original wake-word audio (e.g., Hey google1.m4a)  
- Noise audio (Noise.m4a)  
- Normal speech clips (Normal1cam.m4a, Normalflash.m4a, Normalset.m4a)  

These will be automatically converted to 96 kHz WAV.

---

## **‚ñ∂ 3. Running the Codebase (.py Files)**
Below is the **correct execution order** of all `.py` files in the pipeline.

---

### **Step 1 ‚Äî Audio Conversion**
Run the script to convert all raw audio to 96 kHz WAV:

File to run:  
**convert.py**

Outputs:  
- hey_google_96k.wav  
- noise.wav  

---

### **Step 2 ‚Äî Generate Ultrasonic AM Attack**
File to run:  
**gen_attack_strong.py**

Output:  
- attack_am_strong_23k.wav  

---

### **Step 3 ‚Äî Nonlinearity + Demodulation Simulation**
File to run:  
**demod_sim.py**

Outputs:  
- demod_sim.wav  
- phase1_waveforms.png  

---

### **Step 4 ‚Äî Wake-Word Similarity Check**
File to run:  
**measure_similarity.py**

Computes normalized cross-correlation.

---

### **Step 5 ‚Äî Ultrasonic Band Analysis**
File to run:  
**analyze_band.py**

Output:  
- attack_spectrogram_and_band.png  

---

### **Step 6 ‚Äî Adaptive Ultrasonic Detector**
File to run:  
**detector_adaptive.py**

Outputs:  
- detection frame timing  
- detector_adaptive_output.png  

---

### **Step 7 ‚Äî Defense System (Detect + Block)**
File to run:  
**detect_and_block.py**

Outputs:  
- blocked.wav  
- blocked_waveform.png  

---

### **Step 8 ‚Äî Frame Timing Check**
File to run:  
**check_frames.py**

Displays:  
- Detected STFT frame indices  
- Corresponding timestamps  

---

### **Step 9 ‚Äî ASR-Proxy Attack Evaluation**
File to run:  
**asr_check_nosmodel.py**

Checks whether the attack triggers wake-word detection.

---

### **Step 10 ‚Äî ASR-Proxy After Defense**
File to run:  
**asr_check_nosmodel_blocked.py**

Evaluates blocked.wav to confirm attack suppression.

---

### **Step 11 ‚Äî Phase-2 Batch Evaluation**
File to run:  
**metrics_phase1.py**  
**phase2_batch.py**

Outputs:  
- results.csv  
- phase2_results.png  

---

### **Step 12 ‚Äî Phase-3 Full Stress Testing**
File to run:  
**phase3_stresstest.py**

Outputs:  
- Phase3_results.csv  
- P3_attack_plot.png  

---

## **üíª 4. Running the Entire Project via Google Colab**
If using the Colab notebook:

1. Upload required audio files in the **Files** panel  
2. Upload all `.py` files  
3. Run the notebook cells sequentially  
4. The notebook automatically:
   - Loads each script  
   - Generates output WAVs  
   - Produces graphs and CSVs  
   - Saves results in `/content`  
   Or Simply
To reproduce all experiments automatically, run the Colab notebook from top to bottom. No manual intervention required.
---

## **üì¶ 5. Final Outputs**
Your project produces:

### **Audio Files**
- Converted recordings  
- Generated ultrasonic attack  
- Demodulated signal  
- Muted/blocked audio  

### **Figures**
- Spectrograms  
- Waveform plots  
- Detector output graphs  
- Performance comparison plots  

### **CSV Results**
- Phase-2 results  
- Phase-3 results  

### **Scripts**
Full pipeline modules

---

## **üìÑ How to Use**
1. Place required audio files into the folder / Colab panel  
2. Run each `.py` module in order **or** simply execute the Colab notebook  
3. Collect WAV, CSV, and PNG results for your report  
4. Include this README.md inside the ZIP submission  

---

## **‚úî Project Complete**
This repository provides a complete, reproducible system demonstrating:

- 23 kHz ultrasonic AM attack  
- Nonlinear demodulation  
- Statistical band-energy detection  
- Low-latency ultrasonic blocking defense  
- Multi-condition robustness evaluation  

